name: Bulk Deploy Workers
on: [workflow_dispatch, push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Master Provisioner
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          export WRANGLER_ACCOUNT_ID="$CLOUDFLARE_ACCOUNT_ID"
          while IFS= read -r REPO_URL || [ -n "$REPO_URL" ]; do
            [[ -z "$REPO_URL" || "$REPO_URL" =~ ^# ]] && continue
            FOLDER=$(basename "$REPO_URL" .git | cut -d'?' -f1)
            echo "--- Hard Processing: $FOLDER ---"

            git clone --depth 1 "$REPO_URL" "$FOLDER" || continue
            cd "$FOLDER"

            # STUMBLING BLOCK FIX 1: Find the REAL project root (handling subfolders)
            CONFIG_PATH=$(find . -maxdepth 3 -name "wrangler.toml" | head -n 1)
            if [ -n "$CONFIG_PATH" ]; then
              cd $(dirname "$CONFIG_PATH")
            fi

            # STUMBLING BLOCK FIX 2: Strip conflicting IDs and Force nodejs_compat
            if [ -f "wrangler.toml" ]; then
              sed -i '/account_id/d' wrangler.toml
              # Add nodejs_compat flag if not present
              if ! grep -q "nodejs_compat" wrangler.toml; then
                echo 'compatibility_flags = [ "nodejs_compat" ]' >> wrangler.toml
              fi
            fi

            # STUMBLING BLOCK FIX 3: Auto-provision KV/D1 Resources
            if [ -f "wrangler.toml" ]; then
              # Provision KV
              if grep -q "kv_namespaces" wrangler.toml; then
                KV_NAME="${FOLDER}_KV"
                echo "Provisioning KV: $KV_NAME"
                NEW_ID=$(npx wrangler kv:namespace create "$KV_NAME" --json | jq -r '.id' 2>/dev/null || npx wrangler kv:namespace list --json | jq -r ".[] | select(.title == \"$KV_NAME\") | .id")
                [ -n "$NEW_ID" ] && sed -i "s/id = \".*\"/id = \"$NEW_ID\"/" wrangler.toml
              fi
              # Provision D1
              if grep -q "d1_databases" wrangler.toml; then
                DB_NAME="${FOLDER}_DB"
                echo "Provisioning D1: $DB_NAME"
                NEW_ID=$(npx wrangler d1 create "$DB_NAME" --json | jq -r '.database_id' 2>/dev/null || npx wrangler d1 info "$DB_NAME" --json | jq -r '..uuid')
                [ -n "$NEW_ID" ] && sed -i "s/database_id = \".*\"/database_id = \"$NEW_ID\"/" wrangler.toml
              fi
            fi

            # 4. Standard Build & Deploy
            if [ -f "package.json" ]; then
              npm install --no-audit --no-fund || echo "npm fail"
              npm run build || echo "build fail"
            fi

            # Final Deploy Attempt
            npx wrangler deploy --name "$FOLDER" --compatibility-date 2024-01-01 || echo "Deploy skipped for $FOLDER"
            
            # Reset directory for next loop
            cd "$GITHUB_WORKSPACE"
            rm -rf "$FOLDER"
          done < urls.txt
