name: Bulk Deploy Workers
on: [workflow_dispatch, push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cloud-Only Build and Deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          while IFS= read -r REPO_URL || [ -n "$REPO_URL" ]; do
            [[ -z "$REPO_URL" || "$REPO_URL" =~ ^# ]] && continue
            
            FOLDER=$(basename "$REPO_URL" .git | cut -d'?' -f1)
            echo "--- Processing: $FOLDER ---"

            git clone --depth 1 "$REPO_URL" "$FOLDER"
            cd "$FOLDER"

            if [ -f "package.json" ]; then
              npm install --no-audit --no-fund
              npm run build || echo "Build failed, attempting deploy..."
            fi

            # AUTO-DETECT ENTRY POINT
            ENTRY=""
            for f in src/index.ts src/index.js index.ts index.js src/worker.ts worker.ts; do
              if [ -f "$f" ]; then
                ENTRY="$f"
                break
              fi
            done

            if [ -n "$ENTRY" ]; then
              echo "Detected entry point: $ENTRY"
              npx wrangler deploy "$ENTRY" --name "$FOLDER" --compatibility-date 2024-01-01 --minify || echo "Deploy failed"
            else
              # If no file found, try deploying the whole directory as assets (for static sites)
              echo "No entry point found, trying asset deploy..."
              npx wrangler deploy --name "$FOLDER" --compatibility-date 2024-01-01 --assets ./dist || echo "Final deploy attempt failed"
            fi
            
            cd ..
          done < urls.txt
