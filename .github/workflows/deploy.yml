name: Bulk Deploy Workers
on: [workflow_dispatch, push]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Surgical Entry Deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          export WRANGLER_ACCOUNT_ID="$CLOUDFLARE_ACCOUNT_ID"
          # GLOBAL FIX: Install patch-package for the agents repo
          npm install -g patch-package
          
          while IFS= read -r REPO_URL || [ -n "$REPO_URL" ]; do
            [[ -z "$REPO_URL" || "$REPO_URL" =~ ^# ]] && continue
            FOLDER=$(basename "$REPO_URL" .git | cut -d'?' -f1)
            SAFE_NAME=$(echo "$FOLDER" | tr '[:upper:]' '[:lower:]' | tr '.' '-' | tr '_' '-')
            echo "--- Processing: $SAFE_NAME ---"

            git clone --depth 1 "$REPO_URL" "$SAFE_NAME" || continue
            cd "$SAFE_NAME"

            # 1. Monorepo Hunt
            REAL_ROOT=$(find . -maxdepth 3 -name "wrangler.toml" -o -name "package.json" | head -n 1)
            [ -n "$REAL_ROOT" ] && cd $(dirname "$REAL_ROOT")

            # 2. Build with extra flags for Node compatibility
            if [ -f "package.json" ]; then
              npm install --no-audit --no-fund --force --legacy-peer-deps || echo "npm fail"
              npm run build || echo "build fail"
            fi

            # 3. THE SURGERY: Find ONLY real workers (files that export fetch or have event listeners)
            # This skips things like drizzle.config.ts or types.d.ts
            ENTRY=$(grep -rlE "export default|addEventListener" . --include="*.ts" --include="*.js" | grep -vE "node_modules|dist|test|config" | head -n 1)
            
            # If we didn't find one, check the 'dist' folder as a fallback
            [ -z "$ENTRY" ] && ENTRY=$(find dist -name "index.js" 2>/dev/null | head -n 1)

            if [ -n "$ENTRY" ]; then
               echo "üöÄ Valid Entry Found: $ENTRY"
               echo "name = \"$SAFE_NAME\"" > v4-final.toml
               echo "compatibility_date = \"2024-01-01\"" >> v4-final.toml
               echo 'compatibility_flags = [ "nodejs_compat" ]' >> v4-final.toml
               
               # If original toml exists, clean and merge it
               if [ -f "wrangler.toml" ]; then
                  grep -vE "^name|^account_id|^compatibility_date|^compatibility_flags" wrangler.toml >> v4-final.toml
               else
                  echo "main = \"$ENTRY\"" >> v4-final.toml
               fi

               npx wrangler deploy --config v4-final.toml --bundle true || echo "Deploy failed"
            else
               echo "‚ùå Skipping $SAFE_NAME: No valid Worker entry point found."
            fi
            
            cd "$GITHUB_WORKSPACE"
            rm -rf "$SAFE_NAME"
          done < urls.txt
