name: Bulk Deploy Workers
on: [workflow_dispatch, push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Overrider Deploy Logic
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          while IFS= read -r REPO_URL || [ -n "$REPO_URL" ]; do
            [[ -z "$REPO_URL" || "$REPO_URL" =~ ^# ]] && continue
            
            FOLDER=$(basename "$REPO_URL" .git | cut -d'?' -f1)
            echo "--- Processing: $FOLDER ---"

            git clone --depth 1 "$REPO_URL" "$FOLDER"
            cd "$FOLDER"

            # CRITICAL FIX: Remove any existing account_id from wrangler.toml 
            # so it doesn't conflict with your secret.
            if [ -f "wrangler.toml" ]; then
              sed -i '/account_id/d' wrangler.toml
            fi

            # 1. Try to Install/Build
            if [ -f "package.json" ]; then
              npm install --no-audit --no-fund || echo "Install failed"
              npm run build || echo "Build skipped"
            fi

            # 2. Identify Entry Point
            # We look for wrangler.toml first, then index files
            if [ -f "wrangler.toml" ]; then
               echo "üéØ Found Config. Deploying..."
               npx wrangler deploy --name "$FOLDER" --account-id "$CLOUDFLARE_ACCOUNT_ID" --compatibility-date 2024-01-01 || echo "Deploy failed"
            else
               # Search for a JS/TS file if no toml exists
               ENTRY=$(find . -maxdepth 3 \( -name "index.js" -o -name "index.ts" -o -name "worker.js" \) | grep -E "dist/index.js|src/index.ts|src/worker.ts|index.js" | head -n 1)
               
               if [ -n "$ENTRY" ]; then
                  echo "üöÄ Found Entry: $ENTRY. Deploying..."
                  npx wrangler deploy "$ENTRY" --name "$FOLDER" --account-id "$CLOUDFLARE_ACCOUNT_ID" --compatibility-date 2024-01-01 || echo "Deploy failed"
               else
                  echo "‚ö†Ô∏è No entry point found for $FOLDER"
               fi
            fi
            
            cd ..
            rm -rf "$FOLDER"
          done < urls.txt
